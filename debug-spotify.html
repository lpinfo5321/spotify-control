<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Debug Spotify</title>
    <style>
        body {
            font-family: monospace;
            background: #1a1a1a;
            color: #1ed760;
            padding: 20px;
        }
        button {
            background: #1ed760;
            color: black;
            border: none;
            padding: 10px 20px;
            margin: 10px;
            cursor: pointer;
            font-weight: bold;
            border-radius: 20px;
        }
        .result {
            background: #282828;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #1ed760;
        }
        .error {
            color: #ff6b6b;
            border-color: #ff6b6b;
        }
        .success {
            color: #1ed760;
            border-color: #1ed760;
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ Debug de Spotify Integration</h1>
    
    <button onclick="checkLocalStorage()">ğŸ” Verificar localStorage</button>
    <button onclick="clearAuth()">ğŸ§¹ Limpiar AutenticaciÃ³n</button>
    <button onclick="testSaveCode()">ğŸ’¾ Test Guardar CÃ³digo</button>
    <button onclick="manualProcess()">ğŸš€ Procesar Manualmente</button>
    <button onclick="fixConnection()">ğŸ”§ Arreglar ConexiÃ³n</button>
    
    <div id="results"></div>
    
    <script>
        function addResult(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `<pre>${message}</pre>`;
            document.getElementById('results').prepend(div);
        }
        
        function checkLocalStorage() {
            addResult('=== VERIFICANDO LOCALSTORAGE ===', 'info');
            
            const items = {
                'spotify_auth_code': localStorage.getItem('spotify_auth_code'),
                'spotify_code_verifier': localStorage.getItem('spotify_code_verifier'),
                'spotify_state': localStorage.getItem('spotify_state'),
                'spotify_access_token': localStorage.getItem('spotify_access_token')
            };
            
            for (const [key, value] of Object.entries(items)) {
                if (value) {
                    addResult(`âœ… ${key}: ${value.substring(0, 50)}...`, 'success');
                } else {
                    addResult(`âŒ ${key}: NO ENCONTRADO`, 'error');
                }
            }
            
            // Verificar si el cÃ³digo estÃ¡ en la URL
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            if (code) {
                addResult(`âš ï¸ CÃ“DIGO EN URL: ${code.substring(0, 30)}...`, 'success');
                addResult('ğŸ’¡ El cÃ³digo estÃ¡ en la URL pero no en localStorage!', 'error');
            }
        }
        
        function clearAuth() {
            addResult('ğŸ§¹ Limpiando datos de autenticaciÃ³n...', 'info');
            localStorage.removeItem('spotify_auth_code');
            localStorage.removeItem('spotify_code_verifier');
            localStorage.removeItem('spotify_state');
            localStorage.removeItem('spotify_access_token');
            addResult('âœ… Datos limpiados', 'success');
        }
        
        function testSaveCode() {
            const testCode = 'TEST_CODE_' + Date.now();
            localStorage.setItem('spotify_auth_code', testCode);
            const saved = localStorage.getItem('spotify_auth_code');
            
            if (saved === testCode) {
                addResult('âœ… localStorage funciona correctamente', 'success');
                addResult(`CÃ³digo guardado: ${testCode}`, 'info');
            } else {
                addResult('âŒ ERROR: localStorage no funciona!', 'error');
            }
        }
        
        function manualProcess() {
            addResult('ğŸš€ Intentando procesar manualmente...', 'info');
            
            const code = localStorage.getItem('spotify_auth_code');
            const verifier = localStorage.getItem('spotify_code_verifier');
            
            if (!code) {
                addResult('âŒ No hay cÃ³digo en localStorage', 'error');
                
                // Intentar obtener de la URL
                const urlParams = new URLSearchParams(window.location.search);
                const urlCode = urlParams.get('code');
                if (urlCode) {
                    addResult('ğŸ’¡ CÃ³digo encontrado en URL, guardando...', 'info');
                    localStorage.setItem('spotify_auth_code', urlCode);
                    addResult('âœ… CÃ³digo guardado desde URL', 'success');
                }
            }
            
            if (!verifier) {
                addResult('âš ï¸ No hay code verifier - generando uno nuevo', 'error');
                // Generar uno nuevo si no existe
                const newVerifier = generateRandomString(128);
                localStorage.setItem('spotify_code_verifier', newVerifier);
                addResult('âœ… Code verifier generado', 'success');
            }
            
            if (window.spotifyIntegration && typeof window.spotifyIntegration.handleAuthorizationCode === 'function') {
                const finalCode = localStorage.getItem('spotify_auth_code');
                if (finalCode) {
                    addResult('ğŸ”„ Procesando cÃ³digo con spotifyIntegration...', 'info');
                    window.spotifyIntegration.handleAuthorizationCode(finalCode);
                    addResult('âœ… CÃ³digo enviado a procesar', 'success');
                }
            } else {
                addResult('âŒ spotifyIntegration no estÃ¡ disponible', 'error');
            }
        }
        
        function generateRandomString(length) {
            const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            const values = crypto.getRandomValues(new Uint8Array(length));
            return values.reduce((acc, x) => acc + possible[x % possible.length], '');
        }
        
        function fixConnection() {
            addResult('ğŸ”§ Intentando arreglar la conexiÃ³n...', 'info');
            
            // Paso 1: Limpiar todo
            clearAuth();
            
            // Paso 2: Abrir la pÃ¡gina principal
            addResult('ğŸ“± Abriendo pÃ¡gina principal en nueva pestaÃ±a...', 'info');
            window.open('http://127.0.0.1:8000', '_blank');
            
            addResult(`
âœ… INSTRUCCIONES:
1. Ve a la nueva pestaÃ±a
2. Ve a "AdministraciÃ³n"
3. Haz clic en "Conectar Spotify"
4. Autoriza en el popup
5. Si el popup no se cierra, ejecuta en consola:
   debugSpotifyAuth()
            `, 'success');
        }
        
        // Verificar automÃ¡ticamente al cargar
        window.onload = () => {
            addResult('ğŸ” Debug iniciado - ' + new Date().toLocaleTimeString(), 'info');
            checkLocalStorage();
        };
    </script>
</body>
</html>